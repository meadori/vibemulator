package display

import (
	"image/color"

	"github.com/hajimehoshi/ebiten/v2"

	"github.com/meadori/vibemulator/bus"
)

const (
	screenWidth  = 256
	screenHeight = 240
)

var palette = []color.Color{
	{0x80, 0x80, 0x80}, {0x00, 0x3D, 0xA6}, {0x00, 0x12, 0xB0}, {0x44, 0x00, 0x96},
	{0xA1, 0x00, 0x5E}, {0xC7, 0x00, 0x28}, {0xBA, 0x06, 0x00}, {0x8C, 0x17, 0x00},
	{0x5C, 0x2F, 0x00}, {0x10, 0x45, 0x00}, {0x05, 0x4A, 0x00}, {0x00, 0x47, 0x2E},
	{0x00, 0x41, 0x66}, {0x00, 0x00, 0x00}, {0x05, 0x05, 0x05}, {0x05, 0x05, 0x05},
	{0xC7, 0xC7, 0xC7}, {0x00, 0x77, 0xFF}, {0x21, 0x55, 0xFF}, {0x82, 0x37, 0xFA},
	{0xEB, 0x2F, 0xB5}, {0xFF, 0x33, 0x82}, {0xFF, 0x47, 0x55}, {0xD8, 0x5F, 0x21},
	{0x9A, 0x76, 0x00}, {0x38, 0x8F, 0x00}, {0x05, 0x97, 0x00}, {0x00, 0x93, 0x38},
	{0x00, 0x83, 0x8D}, {0x00, 0x00, 0x00}, {0x0F, 0x0F, 0x0F}, {0x0F, 0x0F, 0x0F},
	{0xFF, 0xFF, 0xFF}, {0x3F, 0xBF, 0xFF}, {0x5F, 0x97, 0xFF}, {0xA6, 0x8B, 0xFF},
	{0xF7, 0x7B, 0xFF}, {0xFF, 0x77, 0xB5}, {0xFF, 0x77, 0x82}, {0xFF, 0x9B, 0x5F},
	{0xF3, 0xBF, 0x3F}, {0x83, 0xD7, 0x13}, {0x47, 0xE7, 0x21}, {0x21, 0xF3, 0x83},
	{0x00, 0xE3, 0xD7}, {0x00, 0x00, 0x00}, {0x1B, 0x1B, 0x1B}, {0x1B, 0x1B, 0x1B},
	{0xFF, 0xFF, 0xFF}, {0xAB, 0xE7, 0xFF}, {0xC7, 0xD7, 0xFF}, {0xD7, 0xCB, 0xFF},
	{0xFF, 0xC7, 0xFF}, {0xFF, 0xC7, 0xDB}, {0xFF, 0xBF, 0xB3}, {0xFF, 0xDB, 0xAB},
	{0xFF, 0xE7, 0xA3}, {0xE7, 0xFF, 0xA3}, {0xAB, 0xF3, 0xBF}, {0xB3, 0xFF, 0xCF},
	{0x9F, 0xFF, 0xF3}, {0x00, 0x00, 0x00}, {0x2B, 0x2B, 0x2B}, {0x2B, 0x2B, 0x2B},
}


// Display represents the game window.
type Display struct {
	*ebiten.Image
	bus *bus.Bus
}

// New creates a new Display instance.
func New(b *bus.Bus) *Display {
	ebiten.SetWindowSize(screenWidth*2, screenHeight*2)
	ebiten.SetWindowTitle("vibemulator")
	return &Display{
		Image: ebiten.NewImage(screenWidth, screenHeight),
		bus:   b,
	}
}

// Update proceeds the game state.
// Update is called every tick (1/60 [s] by default).
func (d *Display) Update() error {
	for i := 0; i < 29780; i++ {
		d.bus.Clock()
	}
	return nil
}

// Draw draws the game screen.
// Draw is called every frame (typically 1/60[s] for 60Hz display).
func (d *Display) Draw(screen *ebiten.Image) {
	pixels := d.bus.GetPPU().GetPixels()
	for i := 0; i < len(pixels); i++ {
		d.Image.Set(i%screenWidth, i/screenWidth, palette[pixels[i]])
	}

	screen.DrawImage(d.Image, nil)
}

// Layout takes the outside size (e.g. window size) and returns the (logical) screen size.
// If you don't have to adjust the screen size with the outside size, just return a fixed size.
func (d *Display) Layout(outsideWidth, outsideHeight int) (int, int) {
	return screenWidth, screenHeight
}
