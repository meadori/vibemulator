syntax = "proto3";

package api;

option go_package = "github.com/meadori/vibemulator/api";

service ControllerService {
  // Client streams button states to the emulator
  rpc StreamInput(stream InputState) returns (stream Empty) {}

  // RL Endpoints
  // Requests the current frame buffer (pixels) from the PPU
  rpc GetFrame(Empty) returns (FrameResponse) {}
  
  // Reads a byte from the NES system bus (used to calculate RL rewards/done state)
  rpc ReadMemory(MemoryRequest) returns (MemoryResponse) {}

  // Loads an emulator save state from a file, bypassing the title screen
  rpc LoadState(StateRequest) returns (Empty) {}

  // Triggers a hardware reset of the NES (returns game to title screen)
  rpc ResetSystem(Empty) returns (Empty) {}

  // --- VDB (Vibemulator Debugger) Endpoints ---
  rpc Pause(Empty) returns (Empty) {}
  rpc Resume(Empty) returns (Empty) {}
  rpc Step(Empty) returns (Empty) {}
  rpc GetCPUState(Empty) returns (CPUStateResponse) {}
  rpc ReadMemoryBlock(MemoryBlockRequest) returns (MemoryBlockResponse) {}
}

message CPUStateResponse {
  uint32 pc = 1;
  uint32 sp = 2;
  uint32 a = 3;
  uint32 x = 4;
  uint32 y = 5;
  uint32 status = 6;
  uint32 cycles = 7;
}

message MemoryBlockRequest {
  uint32 address = 1;
  uint32 size = 2;
}

message MemoryBlockResponse {
  bytes data = 1;
}

message StateRequest {
  string filename = 1;
}

message InputState {
  // Player 1 or 2
  int32 player_index = 1;
  
  // NES Controller Buttons
  bool a = 2;
  bool b = 3;
  bool select = 4;
  bool start = 5;
  bool up = 6;
  bool down = 7;
  bool left = 8;
  bool right = 9;
}

message FrameResponse {
  // Raw pixel data. Can be RGB or RGBA depending on the PPU output.
  bytes pixels = 1;
}

message MemoryRequest {
  uint32 address = 1;
}

message MemoryResponse {
  uint32 data = 1;
}

message Empty {}